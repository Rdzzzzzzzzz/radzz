<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gallery | Upload & Share Your Moments</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* (Gunakan style yang sama seperti file asli; untuk ringkas saya pakai style minimal di sini.
       Jika mau, Anda bisa mengganti dengan style penuh dari file asli Anda.) */
    :root{--primary:#6a11cb;--secondary:#2575fc;--accent:#ff4e50;--light:#f8f9fa}
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto}
    body{background:#0f172a;color:var(--light);min-height:100vh;padding:24px}
    .container{max-width:1000px;margin:0 auto}
    header{margin-bottom:18px}
    h1{color:var(--primary)}
    .card{background:rgba(255,255,255,0.04);padding:18px;border-radius:12px;margin-bottom:18px}
    label{display:block;margin-bottom:6px;color:#cbd5e1}
    input[type="text"], textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--light)}
    input[type="file"]{color:var(--light)}
    .checkbox-group{display:flex;gap:8px;align-items:center}
    button{background:linear-gradient(135deg,var(--primary),var(--secondary));color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px;margin-top:12px}
    .gallery-item{background:rgba(255,255,255,0.03);padding:8px;border-radius:10px;overflow:hidden;cursor:pointer}
    .gallery-image{width:100%;height:160px;object-fit:cover;border-radius:6px}
    .privacy-badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
    .privacy-public{background:rgba(76,175,80,0.12);color:#4CAF50;border:1px solid rgba(76,175,80,0.2)}
    .privacy-private{background:rgba(244,67,54,0.12);color:#F44336;border:1px solid rgba(244,67,54,0.2)}
    .share-link{word-break:break-all;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;margin-top:8px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    .share-view{max-width:900px;margin:18px auto}
    .share-image{max-width:100%;height:auto;border-radius:8px}
    .meta{color:#cbd5e1;margin-top:8px}
    .copy-btn{margin-left:8px}
    footer{margin-top:24px;color:#9ca3af}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Gallery</h1>
      <p>Upload & bagikan foto — centang <strong>Public</strong> untuk dapat membuat link publik.</p>
    </header>

    <!-- Jika ada parameter share, tampilkan halaman share saja -->
    <div id="share-container" style="display:none" class="card share-view">
      <h2>Shared Image</h2>
      <div id="shared-content">
        <!-- Isi diisi lewat JS -->
      </div>
      <div style="margin-top:12px">
        <button id="back-to-gallery">Kembali ke Gallery</button>
      </div>
    </div>

    <!-- Upload form -->
    <div class="card" id="upload-card">
      <h3>Upload Gambar Baru</h3>
      <form id="upload-form">
        <div style="margin-top:10px">
          <label for="image-title">Judul</label>
          <input id="image-title" required placeholder="Masukkan judul" />
        </div>
        <div style="margin-top:10px">
          <label for="image-creator">Nama Uploader</label>
          <input id="image-creator" required placeholder="Nama Anda" />
        </div>
        <div style="margin-top:10px">
          <label for="image-description">Deskripsi</label>
          <textarea id="image-description" rows="3" required placeholder="Deskripsi"></textarea>
        </div>
        <div style="margin-top:10px">
          <label for="image-file">Pilih Gambar</label>
          <input id="image-file" type="file" accept="image/*" required />
        </div>
        <div style="margin-top:10px" class="checkbox-group">
          <input id="image-public" type="checkbox" checked />
          <label for="image-public">Jadikan gambar public (dapat dilihat semua orang dengan link)</label>
        </div>

        <div style="margin-top:12px" class="top-actions">
          <button type="submit"><i class="fas fa-cloud-upload-alt"></i> Upload</button>
          <div id="public-actions" style="display:none;align-self:center">
            <small style="color:#cbd5e1">Setelah upload, klik "Dapatkan Link Publik" untuk membuat link.</small>
          </div>
        </div>

        <div id="generated-link-area" style="display:none;margin-top:12px">
          <div class="share-link" id="generated-link"></div>
          <div style="margin-top:8px">
            <button id="copy-link">Salin Link</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Gallery -->
    <div class="card" id="gallery-card">
      <h3>Gallery Foto</h3>
      <div id="image-gallery" class="gallery">
        <!-- Dinamis -->
      </div>
    </div>

    <footer>
      <p>© 2025 Gallery — dibuat cepat. Untuk akses publik yang konsisten, host file ini di web (GitHub Pages, Netlify, dsb.)</p>
    </footer>
  </div>

  <script>
    // Helper: baca query param
    function getQueryParam(key) {
      const params = new URLSearchParams(window.location.search);
      return params.get(key);
    }

    // Saat halaman dibuka dengan ?share=..., decode dan tampilkan
    function tryShowShared() {
      const payload = getQueryParam('share');
      if (!payload) return false;
      try {
        const json = JSON.parse(decodeURIComponent(atob(payload)));
        // Tampilkan konten share-only
        document.getElementById('upload-card').style.display = 'none';
        document.getElementById('gallery-card').style.display = 'none';
        const sc = document.getElementById('share-container');
        sc.style.display = 'block';
        const box = document.getElementById('shared-content');
        box.innerHTML = `
          <h3>${escapeHtml(json.title)}</h3>
          <img src="${json.imageUrl}" alt="${escapeHtml(json.title)}" class="share-image">
          <div class="meta">
            <div><strong>Uploader:</strong> ${escapeHtml(json.creator)}</div>
            <div><strong>Tanggal:</strong> ${escapeHtml(json.date)}</div>
            <div style="margin-top:8px">${escapeHtml(json.description)}</div>
          </div>
        `;
        // Back button
        document.getElementById('back-to-gallery').addEventListener('click', () => {
          window.location.href = window.location.pathname;
        });
        return true;
      } catch (e) {
        console.error('Gagal decode share payload', e);
        return false;
      }
    }

    // Escape HTML untuk keamanan tampilan
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/[&<>"']/g, function(m){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
    }

    // Format tanggal dd-mm-yyyy
    function formatDate(d) {
      const date = new Date(d);
      const day = String(date.getDate()).padStart(2,'0');
      const mon = String(date.getMonth()+1).padStart(2,'0');
      const y = date.getFullYear();
      return `${day}-${mon}-${y}`;
    }

    // Simpan image ke localStorage (gallery)
    function saveImageToStorage(obj) {
      const arr = JSON.parse(localStorage.getItem('galleryImages')||'[]');
      arr.unshift(obj);
      localStorage.setItem('galleryImages', JSON.stringify(arr));
    }

    // Load gallery
    function loadGallery() {
      const arr = JSON.parse(localStorage.getItem('galleryImages')||'[]');
      const g = document.getElementById('image-gallery');
      g.innerHTML = '';
      if (arr.length === 0) {
        g.innerHTML = '<div style="grid-column:1/-1;color:#cbd5e1">Belum ada gambar. Silakan upload!</div>';
        return;
      }
      arr.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'gallery-item';
        div.dataset.id = item.id;
        const badge = item.public ? '<span class="privacy-badge privacy-public"><i class="fas fa-globe"></i> Public</span>' : '<span class="privacy-badge privacy-private"><i class="fas fa-lock"></i> Private</span>';
        div.innerHTML = `
          <img src="${item.imageUrl}" alt="${escapeHtml(item.title)}" class="gallery-image">
          <div style="margin-top:8px">
            <strong>${escapeHtml(item.title)}</strong> ${badge}
            <div style="color:#9ca3af;font-size:13px">${escapeHtml(item.creator)} • ${escapeHtml(item.date)}</div>
            <div style="margin-top:6px;color:#cbd5e1">${escapeHtml(item.description)}</div>
            <div style="margin-top:8px">
              <button class="btn-get-link" data-id="${item.id}">Dapatkan Link Publik</button>
            </div>
          </div>
        `;
        g.appendChild(div);
      });
      // pasang listener tombol Dapatkan Link
      document.querySelectorAll('.btn-get-link').forEach(b=>{
        b.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const id = b.dataset.id;
          const arr = JSON.parse(localStorage.getItem('galleryImages')||'[]');
          const it = arr.find(x=>x.id===id);
          if (!it) { alert('Item tidak ditemukan'); return; }
          if (!it.public) { alert('Gambar ini bersifat private. Tandai public saat upload untuk membuat link.'); return; }
          const shareUrl = createShareLinkFromObject(it);
          showGeneratedLink(shareUrl);
        });
      });
    }

    // Buat share link dari object gambar (embed payload base64)
    function createShareLinkFromObject(item) {
      // buat payload kecil
      const payload = {
        id: item.id,
        title: item.title,
        creator: item.creator,
        date: item.date,
        description: item.description,
        imageUrl: item.imageUrl
      };
      try {
        const json = JSON.stringify(payload);
        const b64 = btoa(encodeURIComponent(json));
        const link = `${location.origin}${location.pathname}?share=${b64}`;
        return link;
      } catch (e) {
        // fallback tanpa encodeURIComponent (untested)
        const b64 = btoa(JSON.stringify(payload));
        return `${location.origin}${location.pathname}?share=${b64}`;
      }
    }

    // Tampilkan link yang dihasilkan
    function showGeneratedLink(link) {
      document.getElementById('generated-link-area').style.display = 'block';
      document.getElementById('generated-link').textContent = link;
      // copy button
      document.getElementById('copy-link').onclick = function(){
        navigator.clipboard.writeText(link).then(()=> alert('Link disalin ke clipboard!'), ()=> alert('Gagal menyalin, silakan salin manual.'));
      };
    }

    // Handler upload form: buat data URL, simpan, dan (jika public) buat link otomatis
    document.getElementById('upload-form').addEventListener('submit', function(e){
      e.preventDefault();
      const title = document.getElementById('image-title').value.trim();
      const creator = document.getElementById('image-creator').value.trim();
      const description = document.getElementById('image-description').value.trim();
      const fileInput = document.getElementById('image-file');
      const isPublic = document.getElementById('image-public').checked;

      if (!fileInput.files || !fileInput.files[0]) { alert('Pilih file gambar terlebih dahulu'); return; }
      const file = fileInput.files[0];
      // validasi tipe
      if (!file.type.startsWith('image/')) { alert('File bukan gambar'); return; }

      const reader = new FileReader();
      reader.onload = function(ev) {
        const dataUrl = ev.target.result;
        const obj = {
          id: Date.now().toString(),
          title,
          creator,
          description,
          date: formatDate(new Date()),
          imageUrl: dataUrl,
          public: isPublic
        };
        saveImageToStorage(obj);
        loadGallery();
        // jika public, buat link otomatis dan tampilkan area
        if (isPublic) {
          const link = createShareLinkFromObject(obj);
          showGeneratedLink(link);
        } else {
          document.getElementById('generated-link-area').style.display = 'none';
        }
        // reset form
        document.getElementById('upload-form').reset();
      };
      reader.readAsDataURL(file);
    });

    // Tombol copy link global akan ditangani saat link dihasilkan
    // Tampilkan/hide indikator public-actions saat checkbox berubah
    document.getElementById('image-public').addEventListener('change', function(){
      document.getElementById('public-actions').style.display = this.checked ? 'block' : 'none';
    });

    // Jika pengguna klik "Dapatkan Link Publik" dari gallery: handled di loadGallery()

    // Inisialisasi
    (function init(){
      // cek apakah membuka halaman share
      const showingShare = tryShowShared();
      if (showingShare) return;
      // normal gallery page
      document.getElementById('public-actions').style.display = document.getElementById('image-public').checked ? 'block' : 'none';
      loadGallery();
    })();
  </script>
</body>
</html>